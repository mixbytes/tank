---
- name: Prepare 1
  hosts: all
  strategy: free
  become: true
  gather_facts: false
  tasks:
    - name: Install python2 for Ansible
      raw: bash -c "test -e /usr/bin/python || (apt -qqy update && apt install -qqy python-minimal)"
      register: output
      changed_when:
        - output.stdout != ""
        - output.stdout != "\r\n"
    - name: Gathering Facts
      setup:

- name: Prepare 2
  hosts: all
  strategy: free
  become: true
  gather_facts: true
  roles:
    - role: geerlingguy.docker
    - role: azavea.ansible-pip

- name: Converge boot node
  hosts: "*boot*"
  become: true
  vars:
    bc_haya_comp_state_wallet: present
    bc_haya_comp_state_boot: present
    bc_haya_comp_state_bench: present
    install_promstack: true
    bc_haya_node_id: 0
    bc_haya_plugin_randpa: present
  roles:
    - role: mixbytes.haya

- name: Converge producer node
  hosts: "*producer*"
  become: true
  vars:
    bc_haya_comp_state_prod: present
    bc_haya_comp_state_bench: present
    install_promstack: true
    bc_haya_node_id: "{{ play_hosts.index(inventory_hostname) | int + 1 }}"
    bc_haya_plugin_randpa: present
  roles:
    - role: mixbytes.haya

- name: Converge full node
  hosts: "*full*"
  become: true
  vars:
    bc_haya_comp_state_prod: present
    bc_haya_comp_state_bench: present
    install_promstack: true
    bc_haya_node_id: "{{ play_hosts.index(inventory_hostname) | int + 1 }}"
    bc_haya_plugin_randpa: present
    bc_haya_isproduction_enabled: "false"
  roles:
    - role: mixbytes.haya

- name: Converge monitoring node
  hosts: "*monitoring*"
  become: true
  vars:
    bc_haya_comp_state_monitoring: present
    install_promstack: true
    admin_user: tank
    admin_password: tank
  roles:
    - role: mixbytes.haya
